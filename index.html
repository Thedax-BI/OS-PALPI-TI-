<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OS PALPI-TI ‚Äî Palpites x Resultados</title>
<meta name="color-scheme" content="dark light">
<style>
:root{--bg:#0b1020;--card:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--line:#1f2937;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
.wrap{max-width:1200px;margin:26px auto;padding:0 16px}
.h1{font-size:26px;font-weight:900;letter-spacing:.3px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.muted{color:var(--muted)}
.row{display:grid;gap:16px}
@media(min-width:980px){.row{grid-template-columns:1.15fr .85fr}}
.card{background:linear-gradient(180deg, rgba(96,165,250,.12), transparent 35%), var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
.filters{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr 1fr;margin-bottom:8px}
select,input{background:#0a1224;border:1px solid #1e293b;border-radius:12px;padding:8px 10px;color:var(--text)}
.tbl{width:100%;border-collapse:separate;border-spacing:0}
.tbl th,.tbl td{padding:9px 10px;border-bottom:1px solid var(--line);vertical-align:middle}
.tbl th{font-size:12px;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
.kpi{display:grid;gap:10px;grid-template-columns:repeat(6,1fr)}
.k{background:#0a1224;border:1px solid var(--line);border-radius:12px;padding:10px}
.k b{display:block;font-size:20px;margin-top:2px}
.crestBox{display:flex;gap:10px;align-items:center}
.crest{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid #223;box-shadow:0 6px 14px rgba(0,0,0,.25);overflow:hidden}
.crest img{width:100%;height:100%;object-fit:cover;display:block}
.crest.fallback.t1{background:radial-gradient(circle at 30% 30%, #7dd3fc, #1e3a8a)}
.crest.fallback.t2{background:radial-gradient(circle at 30% 30%, #fca5a5, #7c2d12)}
.badge{font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid #334155}
.badge.ok{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35);color:#86efac}
.badge.warn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:#fde68a}
.badge.bad{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35);color:#fecaca}
.badge.pend{background:rgba(148,163,184,.14);border-color:rgba(148,163,184,.35);color:#cbd5e1}
.btn{cursor:pointer;background:var(--accent);color:#061225;border:none;border-radius:10px;padding:8px 12px;font-weight:800}
.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
.small{font-size:12px}
.gridcards{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));margin-top:8px}
.cardMatch{background:#0a1224;border:1px solid var(--line);border-radius:14px;padding:10px}
.matchHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.teams{display:flex;gap:10px;align-items:center}
.score{font-weight:900;font-size:18px}
.sticker{font-size:18px;margin-right:6px}
.toast{position:fixed;right:16px;bottom:16px;background:#111827;border:1px solid #30363d;color:#e5e7eb;padding:10px 12px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.35);display:none}
.err{background:#1b2437;border:1px solid #3b4861;color:#e2e8f0;padding:10px;border-radius:10px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">üèÜ OS PALPI-TI ‚Äî Palpites x Resultados
    <span class="muted" id="status">carregando‚Ä¶</span>
  </div>

  <div class="row">
    <div class="card">
      <div class="filters">
        <select id="fPalpiteiro"><option value="">Todos os palpiteiros</option></select>
        <select id="fLiga"><option value="">Todos os campeonatos</option></select>
        <select id="fData"><option value="">Todas as datas</option></select>
        <input id="fBusca" placeholder="Buscar por time/jogo‚Ä¶" />
        <button class="btn ghost" id="btnReset">Limpar</button>
      </div>
      <div id="err" class="err" style="display:none"></div>
      <div class="kpi" id="kpi"></div>
      <table class="tbl" id="tblDetalhe">
        <thead><tr>
          <th>Data</th><th>Campeonato</th><th>Jogo</th><th>Palpiteiro</th><th>Palpite</th><th>Resultado</th><th>Status/Pontos</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="small muted" style="margin-top:8px">
        Pontua√ß√£o: vencedor=3 ‚Ä¢ vencedor+placar=6 ‚Ä¢ vencedor+mesma margem=1 ‚Ä¢ pendente=1 (provis√≥rio) ‚Ä¢ erro=0
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button class="btn" id="btnCopiarLink">Copiar link com filtros</button>
        <button class="btn ghost" id="btnRecarregar">Recarregar</button>
      </div>
      <table class="tbl" id="tblRank">
        <thead><tr>
          <th>Palpiteiro</th><th>Pts</th><th>Exatos</th><th>Vencedor</th><th>Margem</th><th>Provis.</th><th>Erros</th><th>Aprov.</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="muted small" style="margin-bottom:6px">Jogos</div>
    <div class="gridcards" id="cards"></div>
  </div>
</div>

<div class="toast" id="toast">Link copiado!</div>

<script>
const CONFIG = {
  SHEET_ID: "1BN8qI5_QnTPbpBxd4yT-Ng6qmDChLFhXohHFnY4R5vE",
  SHEET_NAME: "Respostas ao formul√°rio 1",
  CRESTS: {'S√£o Paulo': 'https://commons.wikimedia.org/wiki/Special:FilePath/Brasao%20do%20Sao%20Paulo%20Futebol%20Clube.svg', 'Sport Club Internacional': 'https://commons.wikimedia.org/wiki/Special:FilePath/Escudo%20do%20Sport%20Club%20Internacional.svg', 'Internacional': 'https://commons.wikimedia.org/wiki/Special:FilePath/Escudo%20do%20Sport%20Club%20Internacional.svg', 'Corinthians': 'https://commons.wikimedia.org/wiki/Special:FilePath/SC%20Corinthians.svg', 'Sport Club Corinthians Paulista': 'https://commons.wikimedia.org/wiki/Special:FilePath/SC%20Corinthians.svg', 'Fortaleza': 'https://commons.wikimedia.org/wiki/Special:FilePath/FortalezaEsporteClube.svg', 'Fortaleza EC': 'https://commons.wikimedia.org/wiki/Special:FilePath/FortalezaEsporteClube.svg', 'Santos': 'https://commons.wikimedia.org/wiki/Special:FilePath/Santos%20logo.svg', 'EC Juventude': 'https://commons.wikimedia.org/wiki/Special:FilePath/EC%20Juventude.svg', 'Juventude': 'https://commons.wikimedia.org/wiki/Special:FilePath/EC%20Juventude.svg', 'Athletico Paranaense': 'https://commons.wikimedia.org/wiki/Special:FilePath/Athletico%20Paranaense%20%28Logo%202019%29.svg', 'Athletico-PR': 'https://commons.wikimedia.org/wiki/Special:FilePath/Athletico%20Paranaense%20%28Logo%202019%29.svg', 'Palmeiras': 'https://commons.wikimedia.org/wiki/Special:FilePath/Palmeiras%20logo.svg', 'Sociedade Esportiva Palmeiras': 'https://commons.wikimedia.org/wiki/Special:FilePath/Palmeiras%20logo.svg'},
};

const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');
const toast = document.getElementById('toast');
const $ = s => document.querySelector(s);

function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1500); }

const patTeamCol = /^Selecione o Time A \[(.+)\]$/;
const gvizUrl = () => {
  const base = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json`;
  return CONFIG.SHEET_NAME ? base + `&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}` : base;
};

function parseGViz(text){
  const json = JSON.parse(text.replace(/^[^\(]*\(/,'').replace(/\);\s*$/,''));
  const cols = json.table.cols.map(c => c.label || c.id || '');
  const rows = json.table.rows.map(r => {
    const o = {};
    r.c?.forEach((c,i)=> o[cols[i]||('col'+(i+1))] = (c?.v ?? c?.f ?? ''));
    return o;
  });
  return rows;
}

function outcome(h, a){ if (h==null||a==null||isNaN(h)||isNaN(a)) return null; if (h>a) return 'H'; if (h<a) return 'A'; return 'D'; }
function score(p1,p2,g1,g2){
  if (g1==null||g2==null||isNaN(g1)||isNaN(g2)) return {status:"Pendente (1 pt provis√≥rio)", pts:1};
  if (p1===g1 && p2===g2) return {status:"Placar exato", pts:6};
  const ocp = outcome(p1,p2), ocr = outcome(g1,g2);
  if (ocp===ocr) return Math.abs(p1-p2)===Math.abs(g1-g2) ? {status:"Vencedor + margem", pts:1} : {status:"Vencedor", pts:3};
  return {status:"Errou", pts:0};
}

function crestHTML(teamName, cls){
  const url = CONFIG.CRESTS[teamName] || null;
  if (url) return `<div class="crest"><img src="${url}" alt="escudo ${teamName}" onerror="this.closest('.crest').classList.add('fallback','${cls}'); this.remove();"></div>`;
  const initials = teamName.split(/\s+/).map(w=>w[0]).filter(Boolean).slice(0,3).join('').toUpperCase();
  return `<div class="crest fallback ${cls}">${initials}</div>`;
}
function sticker(name){
  const emojis = ["ü§ô","üî•","üöÄ","üß†","ü¶ä","üêØ","ü¶æ","üéØ","ü™Ñ","üíé","üß©","‚ö°","üèÜ","üé≤","üéÆ","ü•á","ü•∑","üß≠"];
  let h=0; for(let i=0;i<(name||'').length;i++) h=(h*31+name.charCodeAt(i))>>>0;
  return emojis[h % emojis.length];
}

function badge(status, pts){
  let cls="pend";
  if (status==="Placar exato") cls="ok"; else if (status==="Vencedor") cls="ok";
  else if (status==="Vencedor + margem") cls="warn"; else if (status==="Errou") cls="bad";
  return `<span class="badge ${cls}">${status} ‚Ä¢ ${pts} pts</span>`;
}

function renderKPI(rows){
  const tot=rows.length, ex=rows.filter(r=>r.Status==="Placar exato").length, v=rows.filter(r=>r.Status==="Vencedor").length, m=rows.filter(r=>r.Status==="Vencedor + margem").length, pr=rows.filter(r=>r.Status.startsWith("Pendente")).length, er=rows.filter(r=>r.Status==="Errou").length;
  $('#kpi').innerHTML = `
    <div class="k"><span class="muted">Palpites</span><b>${tot}</b></div>
    <div class="k"><span class="muted">Exatos</span><b>${ex}</b></div>
    <div class="k"><span class="muted">Vencedor</span><b>${v}</b></div>
    <div class="k"><span class="muted">Margem</span><b>${m}</b></div>
    <div class="k"><span class="muted">Provis√≥rios</span><b>${pr}</b></div>
    <div class="k"><span class="muted">Erros</span><b>${er}</b></div>`;
}

function filterRows(rows){
  const p = $('#fPalpiteiro').value, l=$('#fLiga').value, d=$('#fData').value, q=$('#fBusca').value.trim().toLowerCase();
  return rows.filter(r=> (!p||r.Palpiteiro===p) && (!l||r.Campeonato===l) && (!d||r.Data===d) && (!q|| (`${r.team1} ${r.team2} ${r.Jogo}`.toLowerCase().includes(q)) ));
}

function renderDetail(details){
  const tbody = $('#tblDetalhe tbody');
  const rows = filterRows(details);
  tbody.innerHTML = rows.map(r=> {
    const res = (r.g1==null||r.g2==null) ? "‚Äî" : `${r.g1} x ${r.g2}`;
    return `<tr>
      <td>${r.Data}</td><td>${r.Campeonato}</td>
      <td><div class="crestBox">${crestHTML(r.team1,'t1')} ${r.team1} <span class="muted" style="margin:0 6px">x</span> ${crestHTML(r.team2,'t2')} ${r.team2}</div></td>
      <td>${sticker(r.Palpiteiro)} ${r.Palpiteiro}</td>
      <td>${r.p1} x ${r.p2}</td>
      <td>${res}</td>
      <td>${badge(r.Status, r.Pontos)}</td>
    </tr>`;
  }).join('');
  renderKPI(rows);
}

function renderRank(rank){
  $('#tblRank tbody').innerHTML = rank.map(r=>`
    <tr>
      <td>${sticker(r.Palpiteiro)} ${r.Palpiteiro}</td>
      <td><b>${r.Pts}</b></td>
      <td>${r.Exatos}</td>
      <td>${r.Vencedor}</td>
      <td>${r.Margem}</td>
      <td>${r.Provisorios}</td>
      <td>${r.Erros}</td>
      <td>${r.Aproveitamento_}%</td>
    </tr>`).join('');
}

function renderCards(details){
  const uniq = new Map();
  details.forEach(r=>{ const key = r.Data+"|"+r.Campeonato+"|"+r.Jogo; if(!uniq.has(key)) uniq.set(key,r); });
  const rows = Array.from(uniq.values());
  $('#cards').innerHTML = rows.map(r=> {
    const res = (r.g1==null||r.g2==null) ? '<span class="badge pend">Pendente</span>' : `<span class="score">${r.g1} x ${r.g2}</span>`;
    return `<div class="cardMatch">
      <div class="matchHead"><div class="muted small">${r.Data} ‚Ä¢ ${r.Campeonato}</div><div>${res}</div></div>
      <div class="teams">${crestHTML(r.team1,'t1')} <div>${r.team1}</div><div class="muted" style="margin:0 8px">x</div>${crestHTML(r.team2,'t2')} <div>${r.team2}</div></div>
    </div>`;
  }).join('');
}

async function loadData(){
  const url = gvizUrl();
  let resp;
  try {
    resp = await fetch(url, {cache: 'no-store'});
  } catch (e) {
    throw new Error("Falha de rede ao acessar o Google Sheets.");
  }
  if (!resp.ok) {
    throw new Error("Permiss√£o negada pelo Google Sheets (HTTP " + resp.status + "). Dica: abra 'Compartilhar' e selecione 'Qualquer pessoa com o link - Leitor' ou use 'Arquivo > Publicar na Web'.");
  }
  const txt = await resp.text();
  let rows;
  try {
    rows = parseGViz(txt);
  } catch(e) {
    console.error(e);
    throw new Error("N√£o consegui interpretar a resposta do Sheets. Se precisar, informe exatamente o nome da aba em CONFIG.SHEET_NAME (atual: 'Respostas ao formul√°rio 1').");
  }
  return rows;
}

function extractPairs(rows){
  const cols = Object.keys(rows[0]||{});
  const teamCols = cols.filter(c => patTeamCol.test(c));
  const cTS = cols.find(c => /carimbo/i.test(c)) || cols[0];
  const cLiga = cols.find(c => /campeonato|liga|torneio|competic/i.test(c));
  const cData = cols.find(c => /data.*jogo|data/i.test(c));
  const cPalp = cols.find(c => /palpiteiro|participante|respondente/i.test(c));
  if (!teamCols.length) throw new Error("N√£o encontrei colunas 'Selecione o Time A [...]' nesta aba.");
  const tsOf = r => new Date(r[cTS]).getTime() || 0;
  const isResultado = r => {
    const valPalp = String(r[cPalp]||'').trim().toLowerCase();
    const valTipo = cTipo ? String(r[cTipo]||'').trim().toLowerCase() : '';
    return valPalp === 'resultado' || valTipo === 'resultado';
  };

  // results
  const resPairs = [];
  for (const r of rows.filter(isResultado)) {
    const filled = teamCols.map(c=>[c,r[c]]).filter(([,v])=>v!==''&&v!=null);
    if (filled.length!==2) continue;
    const [[c1,g1],[c2,g2]] = filled;
    const t1 = c1.match(patTeamCol)[1], t2 = c2.match(patTeamCol)[1];
    resPairs.push({Campeonato:r[cLiga], Data:r[cData], team1_col:c1, team1:t1, g1:Number(g1), team2_col:c2, team2:t2, g2:Number(g2), _ts:tsOf(r)});
  }
  const resMap = new Map();
  for (const m of resPairs) { const k = `${m.Campeonato}|${m.DataKey}|${m.team1_col}|${m.team2_col}`; const old = resMap.get(k); if (!old||m._ts>old._ts) resMap.set(k,m); }
  const results = Array.from(resMap.values());

  // predictions
  const palps = [];
  for (const r of rows.filter(x=>!isResultado(x))) {
    const filled = teamCols.map(c=>[c,r[c]]).filter(([,v])=>v!==''&&v!=null);
    if (filled.length!==2) continue;
    const [[c1,p1],[c2,p2]] = filled;
    const t1 = c1.match(patTeamCol)[1], t2 = c2.match(patTeamCol)[1];
    const n1 = Number(p1), n2 = Number(p2);
    if (Number.isNaN(n1) || Number.isNaN(n2)) continue;
    palps.push({Palpiteiro:r[cPalp], Campeonato:r[cLiga], Data:r[cData], team1_col:c1, team1:t1, p1:n1, team2_col:c2, team2:t2, p2:n2, _ts:tsOf(r)});
  }
  const palpMap = new Map();
  for (const p of palps) { const k = `${p.Palpiteiro}|${p.Campeonato}|${p.DataKey}|${p.team1_col}|${p.team2_col}`; const old=palpMap.get(k); if(!old||p._ts>old._ts) palpMap.set(k,p); }
  return {results:Array.from(palpMap.keys()) && results, palps:Array.from(palpMap.values())}; // 'results' defined above
}

async function bootstrap(){
  try {
    statusEl.textContent = 'carregando‚Ä¶';
    const rows = await loadData();

    const cols = Object.keys(rows[0]||{});
    const teamCols = cols.filter(c => patTeamCol.test(c));
    const cTS = cols.find(c => /carimbo/i.test(c)) || cols[0];
    const cLiga = cols.find(c => /campeonato|liga|torneio|competic/i.test(c));
    const cData = cols.find(c => /data.*jogo|data/i.test(c));
    const cPalp = cols.find(c => /palpiteiro|participante|respondente/i.test(c));
    const tsOf = r => new Date(r[cTS]).getTime() || 0;
    const isResultado = r => {
    const valPalp = String(r[cPalp]||'').trim().toLowerCase();
    const valTipo = cTipo ? String(r[cTipo]||'').trim().toLowerCase() : '';
    return valPalp === 'resultado' || valTipo === 'resultado';
  };

    // results (last only)
    const resPairs = [];
    for (const r of rows.filter(isResultado)) {
      const filled = teamCols.map(c=>[c,r[c]]).filter(([,v])=>v!==''&&v!=null);
      if (filled.length!==2) continue;
      const [[c1,g1],[c2,g2]] = filled;
      const t1 = c1.match(patTeamCol)[1], t2 = c2.match(patTeamCol)[1];
      resPairs.push({Campeonato:r[cLiga], Data:r[cData], team1_col:c1, team1:t1, g1:Number(g1), team2_col:c2, team2:t2, g2:Number(g2), _ts:tsOf(r)});
    }
    const resMap = new Map(); for (const m of resPairs) { const k = `${m.Campeonato}|${m.DataKey}|${m.team1_col}|${m.team2_col}`; const old=resMap.get(k); if(!old||m._ts>old._ts) resMap.set(k,m); }
    const results = Array.from(resMap.values());

    // palps (last only)
    const palpsRaw = [];
    for (const r of rows.filter(x=>!isResultado(x))) {
      const filled = teamCols.map(c=>[c,r[c]]).filter(([,v])=>v!==''&&v!=null);
      if (filled.length!==2) continue;
      const [[c1,p1],[c2,p2]] = filled;
      const t1 = c1.match(patTeamCol)[1], t2 = c2.match(patTeamCol)[1];
      const n1 = Number(p1), n2 = Number(p2);
      if (Number.isNaN(n1) || Number.isNaN(n2)) continue;
      palpsRaw.push({Palpiteiro:r[cPalp], Campeonato:r[cLiga], Data:r[cData], team1_col:c1, team1:t1, p1:n1, team2_col:c2, team2:t2, p2:n2, _ts:tsOf(r)});
    }
    const palpMap = new Map(); for (const p of palpsRaw) { const k = `${p.Palpiteiro}|${p.Campeonato}|${p.DataKey}|${p.team1_col}|${p.team2_col}`; const old=palpMap.get(k); if(!old||p._ts>old._ts) palpMap.set(k,p); }
    const palps = Array.from(palpMap.values());

    // matches union
    const mkey = m => `${m.Campeonato}|${m.DataKey}|${m.team1_col}|${m.team2_col}`;
    const matchMap = new Map();
    for (const r of results) matchMap.set(mkey(r), r);
    for (const p of palps) if (!matchMap.has(mkey(p))) matchMap.set(mkey(p), p);
    const matches = Array.from(matchMap.values());

    // details and rank
    const details = [];
    for (const m of matches) {
      const g = results.find(x => mkey(x)===mkey(m)) || null;
      const g1 = g? Number(g.g1) : null, g2 = g? Number(g.g2) : null;
      const related = palps.filter(p => p.Campeonato===m.Campeonato && p.Data===m.Data && p.team1_col===m.team1_col && p.team2_col===m.team2_col);
      for (const p of related) {
        const s = score(p.p1, p.p2, g1, g2);
        details.push({ Data:m.Data, Campeonato:m.Campeonato, Jogo:`${m.team1} x ${m.team2}`,
          team1:m.team1, team2:m.team2, Palpiteiro:p.Palpiteiro, p1:p.p1, p2:p.p2,
          g1:(g1!=null&&!isNaN(g1)?g1:null), g2:(g2!=null&&!isNaN(g2)?g2:null), Status:s.status, Pontos:s.pts });
      }
    }

    const byP = new Map();
    for (const r of details) {
      const it = byP.get(r.Palpiteiro) || {Palpiteiro:r.Palpiteiro, Pts:0, Exatos:0, Vencedor:0, Margem:0, Provisorios:0, Erros:0, Total:0};
      it.Pts += r.Pontos; it.Total += 1;
      if (r.Status==="Placar exato") it.Exatos++;
      else if (r.Status==="Vencedor") it.Vencedor++;
      else if (r.Status==="Vencedor + margem") it.Margem++;
      else if (r.Status.startsWith("Pendente")) it.Provisorios++;
      else if (r.Status==="Errou") it.Erros++;
      byP.set(r.Palpiteiro, it);
    }
    const rank = Array.from(byP.values()).map(x=>({...x, Aproveitamento_: Math.round(((x.Exatos+x.Vencedor+x.Margem)/Math.max(1,x.Total))*1000)/10}))
      .sort((a,b)=> b.Pts - a.Pts || b.Exatos - a.Exatos || b.Vencedor - a.Vencedor || b.Margem - a.Margem || b.Aproveitamento_ - a.Aproveitamento_);

    // Fill filters from data
    const uniq = arr => Array.from(new Set(arr)).filter(Boolean).sort();
    const palpiteiros = uniq(details.map(x=>x.Palpiteiro));
    const ligas = uniq(details.map(x=>x.Campeonato));
    const datas = uniq(details.map(x=>x.Data));
    const pf = $('#fPalpiteiro'); palpiteiros.forEach(x=> pf.insertAdjacentHTML('beforeend', `<option>${x}</option>`));
    const lf = $('#fLiga'); ligas.forEach(x=> lf.insertAdjacentHTML('beforeend', `<option>${x}</option>`));
    const df = $('#fData'); datas.forEach(x=> df.insertAdjacentHTML('beforeend', `<option>${x}</option>`));

    // Restore filters from URL
    const usp = new URLSearchParams(location.search);
    if (usp.get('p')) $('#fPalpiteiro').value = usp.get('p');
    if (usp.get('l')) $('#fLiga').value = usp.get('l');
    if (usp.get('d')) $('#fData').value = usp.get('d');
    if (usp.get('q')) $('#fBusca').value = usp.get('q');

    // Wire
    $('#btnReset').addEventListener('click', ()=>{ $('#fPalpiteiro').value=''; $('#fLiga').value=''; $('#fData').value=''; $('#fBusca').value=''; renderDetail(details); });
    $('#btnRecarregar').addEventListener('click', ()=> location.reload());
    $('#btnCopiarLink').addEventListener('click', ()=>{
      const usp2 = new URLSearchParams();
      if ($('#fPalpiteiro').value) usp2.set('p',$('#fPalpiteiro').value);
      if ($('#fLiga').value) usp2.set('l',$('#fLiga').value);
      if ($('#fData').value) usp2.set('d',$('#fData').value);
      if ($('#fBusca').value) usp2.set('q',$('#fBusca').value);
      const url = location.origin + location.pathname + (usp2.toString()?('?'+usp2):'');
      navigator.clipboard.writeText(url).then(()=> showToast('Link copiado!'));
    });
    ['fPalpiteiro','fLiga','fData','fBusca'].forEach(id => document.getElementById(id).addEventListener('input', ()=> renderDetail(details)));

    renderRank(rank);
    renderDetail(details);
    renderCards(details);

    statusEl.textContent = `ok ‚Ä¢ ${rows.length} respostas`;
    errEl.style.display='none';
  } catch (e) {
    statusEl.textContent = 'erro ao carregar';
    errEl.style.display = 'block';
    errEl.innerHTML = `<b>N√£o consegui ler a planilha.</b><br>${e.message}<br><br><b>Checklist r√°pido:</b><br>
      1) Abra sua planilha ‚Üí <i>Compartilhar</i> ‚Üí selecione <b>Qualquer pessoa com o link ‚Äì Leitor</b>.<br>
      2) Se ainda falhar, tente <i>Arquivo ‚Üí Publicar na Web</i> (aba <b>Respostas ao formul√°rio 1</b>).<br>
      3) Se a primeira aba n√£o for a de respostas, ajuste <code>CONFIG.SHEET_NAME</code> para o nome exato.`;
    console.error(e);
  }
}

function renderCards(details){
  const uniq = new Map();
  details.forEach(r=>{ const key = r.Data+"|"+r.Campeonato+"|"+r.Jogo; if(!uniq.has(key)) uniq.set(key,r); });
  const rows = Array.from(uniq.values());
  $('#cards').innerHTML = rows.map(r=> {
    const res = (r.g1==null||r.g2==null) ? '<span class="badge pend">Pendente</span>' : `<span class="score">${r.g1} x ${r.g2}</span>`;
    return `<div class="cardMatch">
      <div class="matchHead"><div class="muted small">${r.Data} ‚Ä¢ ${r.Campeonato}</div><div>${res}</div></div>
      <div class="teams">${crestHTML(r.team1,'t1')} <div>${r.team1}</div><div class="muted" style="margin:0 8px">x</div>${crestHTML(r.team2,'t2')} <div>${r.team2}</div></div>
    </div>`;
  }).join('');
}

bootstrap();
</script>
</body>
</html>
